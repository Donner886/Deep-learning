### Exponentially Moving averages
这是一个非常重要的该概念，广泛的应用于时间序列分析，金融，气象，深度学习（例如优化算法中的Adam, RMSprop等）。

1. 公式说明：
    - 核心思想是对近期的数据给与更高的权重，较早的数据给与较低的权重。权重随着时间呈现指数级的衰减。
    - 公式如下：
    $$
    v_t = \beta v_{t-1} + (1-\beta) \theta_t
    $$
    其中，$v_t$ 是在时间点 $t$ 的指数加权平均值，$\theta_t$ 是在时间点 $t$ 的实际值，$\beta$ 是一个介于0和1之间的平滑参数，决定了权重的衰减速度。
    - 当 $\beta$ 越接近1，表示对过去数据的权重衰减越慢，更多地考虑历史数据；当 $\beta$ 越接近0，表示对近期数据的权重更高，更关注最新的数据。
        - 初始条件：通常情况下，我们设定 $v_0 = 0$ 或者 $v_0 = \theta_0$。
    2. 计算过程：
        - 计算 $v_1$：$v_1 = \beta v_0 + (1-\beta) \theta_1$
        - 计算 $v_2$：$v_2 = \beta v_1 + (1-\beta) \theta_2$
        - 依此类推，计算 $v_t$。    
2. 实用案例： 每日气温
    - 假设我们有一系列每日气温数据，我们希望计算一个平滑的气温趋势。
    - 设定 $\beta = 0.9$，表示我们希望对过去的数据给予较高的权重。
    - 计算过程如下：
        - 第一天：$v_1 = 0.9 \times 0 + 0.1 \times 30 = 3$
        - 第二天：$v_2 = 0.9 \times 3 + 0.1 \times 32 = 3.3 + 3.2 = 6.5$
        - 第三天：$v_3 = 0.9 \times 6.5 + 0.1 \times 31 = 5.85 + 3.1 = 8.95$
        - 第四天：$v_4 = 0.9 \times 8.95 + 0.1 \times 29 = 8.055 + 2.9 = 10.955$
        - 第五天：$v_5 = 0.9 \times 10.955 + 0.1 \times 28 = 9.8595 + 2.8 = 12.6595$
    - 最终得到的指数加权平均气温序列为：[3, 6.5, 8.95, 10.955, 12.6595]，相比原始数据更加平滑，能够更好地反映气温的整体趋势。
    - 为什么会说平滑呢？因为每一天的温度变化不会太大，指数加权平均值会减少短期的波动，更加关注长期趋势。 
    - 为什么会保证这种变换会保证长期趋势不变呢？因为每一天的温度变化不会太大，指数加权平均值会减少短期的波动，更加关注长期趋势。
3. 概念讲解： 
    - 为什么叫做“指数”加权平均？
    如果我们把公式展开， 就能清楚的看到“指数”的来源：
    假设 $v_0 = 0$，那么：
    - $v_1 = (1-\beta) \theta_1$
    - $v_2 = \beta v_1 + (1-\beta) \theta_2 = \beta (1-\beta) \theta_1 + (1-\beta) \theta_2$
    - $v_3 = \beta v_2 + (1-\beta) \theta_3 = \beta^2 (1-\beta) \theta_1 + \beta (1-\beta) \theta_2 + (1-\beta) \theta_3$
    - ......
    - $v_t = (1-\beta) \sum_{i=0}^{t-1} \beta^i \theta_{t-i}$
    - 从展开式可以看出，第t天的值 $v_t$ 是过去所有观测值的加权之和，而每个观测值 $\theta_{k}$ 的权重是 $(1-\beta) \beta^{t-k}$。由于$\beta < 1$， 权重$\beta^{t-k}$ 随着时间回溯 $(t-k)$ 增大而指数级下降，这就是一个典型的指数衰减形式，因此称为“指数”加权平均。
4. 权重分布与偏差修正
    - 权重分布： 权重 $(1-\beta) \beta^{t-k}$ 构成了一个指数衰减的序列。 所有权重之和为近似为1。
    - 有一个重要的概念叫“平均窗口大小”， 他约等于 $\frac{1}{1-\beta}$。 例如， 如果 $\beta=0.9$， 那么平均窗口大小约为10， 这意味着当前的指数加权平均值主要受到过去10个时间点的数据影响。当 $\beta=0.98$， 平均窗口大小约为50， 这意味着当前的指数加权平均值主要受到过去50个时间点的数据影响。
    - 偏差修正： 在初始阶段，由于 $v_0$ 的设定，会导致 $v_1$, $v_2$ 在初期的估计值非常小， 严重偏离真实值。 为了修正这个偏差， 我们可以使用偏差修正公式：
    $$
    v_t^{correct} = \frac{v_t}{1 - \beta^t}
    $$
    1. 当 $t$ 很小时， $1 - \beta^t$ 也很小， 这样可以放大 $v_t$ 的值， 减少初始偏差，使得 $v_t^{correct}$ 更接近真实值。
    2. 当 $t$ 增大时， $1 - \beta^t$ 趋近于1， 因此 $v_t^{correct}$ 逐渐接近 $v_t$。$v_t^{correct}$ 逐渐接近 $v_t$。
    - 因此，在计算的初期阶段使用偏差修正可以获得更准确的估计，尤其是在训练神经网络等对初始值敏感的场景中。 

5. 优点
    - 平滑效果好： 能够有效减少数据的短期波动，突出长期趋势。
    - 计算效率高： 每次更新只需要当前值和上一个加权平均值，计算复杂度低。
    - 适应性强： 通过调整 $\beta$ 可以灵活控制对历史数据的重视程度。
    - 物理意义清晰： 自然的强调近期数据， 符合很多实际应用场景的需求。
6. 缺点
    - 存在滞后性：由于是对历史数据的平滑，EMA曲线总是会滞后于实际数据的变化，尤其是在数据剧烈波动时。
    - 参数选择敏感：不同的 $\beta$ 值会显著影响结果，选择不当可能导致过度平滑或不足平滑。
    - 初始值影响：初始值的选择会影响前期的计算结果，可能需要进行偏差修正。
    - 不适用于非平稳数据：对于趋势性或季节性强的数据，EMA可能无法有效捕捉其变化规律。
7. 应用场景
    - 金融市场分析：用于计算股票价格的移动平均线，帮助识别价格趋势。
    - 机器学习优化：在优化算法如Adam中，用于计算梯度的移动平均，提升训练稳定性。
    - 信号处理：用于平滑噪声信号，提高信号质量。
    - 传感器数据处理：平滑传感器读数，减少测量误差的影响。
    - 时间序列预测：作为特征工程的一部分，帮助模型更好地理解数据的长期趋势。
8. 总结
    - 指数加权平均（EMA）是一种有效的时间序列数据平滑技术，通过对近期数据赋予更高权重，能够突出长期趋势，减少短期波动。其计算简单，适应性强，但也存在滞后性和参数选择敏感等缺点。EMA在金融分析、机器学习优化、信号处理等多个领域有广泛应用，是理解和处理时间序列数据的重要工具。        


9. 补充 “平均窗口大小”的概念
    - 平均窗口大小（Effective Window Size）是理解EMA行为的一个核心概念，他不是一个精确的计数，而是一个极具实用价值的的启发式工具。 
    - 直观理解EMA的“记忆长度”： 平均窗口大小可以被看作是EMA对过去数据的“记忆长度”。 例如， 如果 $\beta=0.9$， 那么平均窗口大小约为10， 这意味着当前的指数加权平均值主要受到过去10个时间点的数据影响。当 $\beta=0.98$， 平均窗口大小约为50， 这意味着当前的指数加权平均值主要受到过去50个时间点的数据影响
    - 计算公式： 平均窗口大小可以通过公式 $\frac{1}{1-\beta}$ 计算得出。 这个公式来源于权重分布的性质， 反映了权重衰减的速度。    
    - 选择 $\beta$ 的指导意义： 理解平均窗口大小有助于我们选择合适的 $\beta$ 值。 如果我们希望EMA对较长时间范围内的数据敏感， 可以选择较大的 $\beta$ 值（例如0.98）， 这样平均窗口大小较大，EMA会考虑更多的历史数据。 相反， 如果我们希望EMA更关注近期数据， 可以选择较小的 $\beta$ 值（例如0.9）， 这样平均窗口大小较小，EMA会更快地响应最新的数据。
    - **平均窗口大小公式$\frac{1}{1-\beta}$的推导过程为：**
    - 我们从EMA的展开式开始：
    $$v_t = (1-\beta) \sum_{i=0}^{t-1} \beta^i \theta_{t-i}$$
    我们可以看到， 在k个时间步长之前的观测值 $\theta_{t-k}$ 的权重为 $(1-\beta) \beta^k$。 现在我们想要计算这些权重的总和， 以了解EMA对过去数据的整体影响。
    - 权重总和可以表示为一个无穷级数：
    $$\text{Total Weight} = (1-\beta) \sum_{k=0}^{\infty} \beta^k$$
    - 定义有效窗口的边界： 在简单移动平均中， 窗口的大小是明确的： 最近N个数据的权重都是1/N, 而更早的数据点的权重为0。 在EMA中所有权重都大于0， 但会指数衰减。我们需要一个标准来判断一个数据点的贡献小到何时可以忽略不计。一个在工程和科学上的非常常用的标准是： **当权重下降到初始权重的 1/e时，被成为e-folding scale， 它类似于半衰期的概念。**
    - 下面求解达到该边界的时间步长N
        - 我们现在要问： 需要回溯多少个时间步， 权重会下降到初始权重的1/e。初始权重为$\beta^{0}$我们将这个问题用方程表示出来： 我们将这个问题用方程$\beta^{N} = \frac{1}{e}$
        - 对等式 $\beta^{N} = \frac{1}{e}$ 两边取自然对数，得到：
            $$
            \ln(\beta^{N}) = \ln\left(\frac{1}{e}\right)
            $$
            $$
            N \ln \beta = -1
            $$
            $$
            N = -\frac{1}{\ln \beta}
            $$
        - 由于 $\beta$ 通常接近于1，可以用泰勒展开近似 $\ln \beta \approx - (1-\beta)$，因此
            $$
            N \approx \frac{1}{1-\beta}
            $$
        - 这就是平均窗口大小的近似推导过程。这个近似在 $\beta$ 接近1时非常准确，实际应用中常用来指导 $\beta$ 的选择。
        - 我们来用$\beta = 0.9$来验算一下：
            - 精确计算 $\ln(0.9) \approx -0.10536$，因此 $N = -\frac{1}{-0.10536} \approx 9.49$，与近似计算 $\frac{1}{1-0.9} = 10$ 非常接近。
           
    